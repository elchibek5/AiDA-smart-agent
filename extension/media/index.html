<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- {{csp}} will be replaced by webview.cspSource; {{nonce}} by a random nonce -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'none';
      img-src {{csp}} https:;
      style-src {{csp}} 'unsafe-inline';
      script-src {{csp}} 'nonce-{{nonce}}';
      connect-src http://localhost:3001 https: http: data: {{csp}};
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIDA Chat</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; }
      #send { padding: 8px 12px; border: 1px solid #444; border-radius: 8px; cursor: pointer; }
      #out { white-space: pre-wrap; margin-top: 12px; }
    </style>
  </head>
  <body>
    <button id="send">Send</button>
    <pre id="out"></pre>
    <script nonce="{{nonce}}">
      const out = document.getElementById('out');
      const btn = document.getElementById('send');

      async function postJSON(url, body) {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const text = await r.text();
        try { return { ok: r.ok, status: r.status, json: JSON.parse(text) }; }
        catch { return { ok: r.ok, status: r.status, text }; }
      }

      btn.addEventListener('click', async () => {
        out.textContent = 'Sending...';
        try {
          // Try /chat first; fall back to /ask if your backend uses that.
          let res = await postJSON('http://localhost:3001/chat', { message: 'hello from webview' });
          if (!res.ok && res.status === 404) {
            res = await postJSON('http://localhost:3001/ask', { prompt: 'hello from webview' });
          }
          out.textContent = JSON.stringify(res, null, 2);
        } catch (e) {
          out.textContent = 'ERROR: ' + (e && e.message ? e.message : String(e));
        }
      });
    </script>
  </body>
</html>
